
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.3.9">
    
    
      
        <title>SQL Support - Fast</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="pink">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sql-support" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Fast" class="md-header__button md-logo" aria-label="Fast" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Fast
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SQL Support
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jonatas/fast" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Fast" class="md-nav__button md-logo" aria-label="Fast" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    Fast
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jonatas/fast" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../walkthrough/" class="md-nav__link">
        Walkthrough
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../syntax/" class="md-nav__link">
        Syntax
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../command_line/" class="md-nav__link">
        Command Line
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../experiments/" class="md-nav__link">
        Experiments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../shortcuts/" class="md-nav__link">
        Shortcuts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../git/" class="md-nav__link">
        Git Integration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../similarity_tutorial/" class="md-nav__link">
        Code Similarity
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../pry-integration/" class="md-nav__link">
        Pry Integration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../editors-integration/" class="md-nav__link">
        Editors' Integration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../research/" class="md-nav__link">
        Research
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ideas/" class="md-nav__link">
        Ideas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../videos/" class="md-nav__link">
        Videos
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        SQL Support
      </a>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/jonatas/fast/edit/master/docs/sql-support.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="sql-support">SQL Support<a class="headerlink" href="#sql-support" title="Permanent link">&para;</a></h1>
<p>Fast is partially supporting SQL syntax. Behind the scenes it parses SQL using
<a href="https://github.com/pganalyze/pg_query">pg_query</a> and simplifies it to AST Nodes
using the same interface. It's using Postgresql parser behind the scenes,
but probably could be useful for other SQL similar diallects.</p>
<div class="admonition info">
<p class="admonition-title">fast auto detects SQL files in the command line</p>
<p>By default, this module is not included into the main library.
Fast can auto-detect file extensions and choose the sql path in case the
file relates to sql.</p>
<p>Use <code>fast --sql</code> in case you want to force the usage of the SQL parser.</p>
<p>```</p>
<p>```</p>
</div>
<h1 id="parsing-a-sql-content">Parsing a sql content<a class="headerlink" href="#parsing-a-sql-content" title="Permanent link">&para;</a></h1>
<div class="codehilite"><pre><span></span><code><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;fast/sql&#39;</span>
<span class="n">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Fast</span><span class="o">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="s1">&#39;select 1&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; s(:select_stmt,</span>
<span class="c1">#     s(:target_list,</span>
<span class="c1">#       s(:res_target,</span>
<span class="c1">#         s(:val,</span>
<span class="c1">#           s(:a_const,</span>
<span class="c1">#             s(:val,</span>
<span class="c1">#               s(:integer,</span>
<span class="c1">#                 s(:ival, 1))))))))</span>
</code></pre></div>

<h2 id="why-its-interesting-to-use-ast-for-sql">Why it's interesting to use AST for SQL?<a class="headerlink" href="#why-its-interesting-to-use-ast-for-sql" title="Permanent link">&para;</a></h2>
<p>Both SQL are available and do the same thing:</p>
<div class="codehilite"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">customers</span>
</code></pre></div>

<p>or</p>
<div class="codehilite"><pre><span></span><code><span class="k">table</span><span class="w"> </span><span class="n">customers</span>
</code></pre></div>

<p>they have exactly the same objective but written down in very different syntax.</p>
<p>Give a try:</p>
<div class="codehilite"><pre><span></span><code><span class="no">Fast</span><span class="o">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="s2">&quot;select * from customers&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">Fast</span><span class="o">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="s2">&quot;table customers&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1"># =&gt; true</span>
</code></pre></div>

<h2 id="match">Match<a class="headerlink" href="#match" title="Permanent link">&para;</a></h2>
<p>Use <code>match?</code> with your node pattern to traverse the abstract syntax tree.</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="no">Fast</span><span class="o">.</span><span class="n">match?</span><span class="p">(</span><span class="s2">&quot;(select_stmt ...)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ast</span><span class="p">)</span><span class="w"> </span><span class="c1"># =&gt; true</span>
</code></pre></div>

<p>Use <code>$</code> to capture elements from the AST:</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="no">Fast</span><span class="o">.</span><span class="n">match?</span><span class="p">(</span><span class="s2">&quot;(select_stmt $...)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ast</span><span class="p">)</span>
<span class="o">=&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">s</span><span class="p">(</span><span class="ss">:target_list</span><span class="p">,</span>
<span class="w">  </span><span class="n">s</span><span class="p">(</span><span class="ss">:res_target</span><span class="p">,</span>
<span class="w">    </span><span class="n">s</span><span class="p">(</span><span class="ss">:val</span><span class="p">,</span>
<span class="w">      </span><span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
<span class="w">        </span><span class="n">s</span><span class="p">(</span><span class="ss">:val</span><span class="p">,</span>
<span class="w">          </span><span class="n">s</span><span class="p">(</span><span class="ss">:integer</span><span class="p">,</span>
<span class="w">            </span><span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)))))))</span><span class="o">]</span>
</code></pre></div>

<p>You can dig deeper into the AST specifying nodes:</p>
<div class="codehilite"><pre><span></span><code><span class="no">Fast</span><span class="o">.</span><span class="n">match?</span><span class="p">(</span><span class="s2">&quot;(select_stmt (target_list (res_target (val ($...)))))&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ast</span><span class="p">)</span>
<span class="c1"># =&gt; [s(:a_const,</span>
<span class="c1">#     s(:val,</span>
<span class="c1">#       s(:integer,</span>
<span class="c1">#         s(:ival, 1))))]</span>
</code></pre></div>

<p>And ignoring node types or values using <code>_</code>. Check all <a href="/syntax">syntax</a> options.</p>
<div class="codehilite"><pre><span></span><code><span class="no">Fast</span><span class="o">.</span><span class="n">match?</span><span class="p">(</span><span class="s2">&quot;(select_stmt (_ (_ (val ($...)))))&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ast</span><span class="p">)</span>
<span class="c1"># =&gt; [s(:a_const,</span>
<span class="c1">#     s(:val,</span>
<span class="c1">#       s(:integer,</span>
<span class="c1">#         s(:ival, 1))))]</span>
</code></pre></div>

<h2 id="search-directly-from-the-ast">Search directly from the AST<a class="headerlink" href="#search-directly-from-the-ast" title="Permanent link">&para;</a></h2>
<p>You can also search directly from nodes and keep digging:</p>
<div class="codehilite"><pre><span></span><code><span class="n">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Fast</span><span class="o">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="s1">&#39;select 1&#39;</span><span class="p">);</span>
<span class="n">ast</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;ival&#39;</span><span class="p">)</span><span class="w"> </span><span class="c1"># =&gt; [s(:ival, s(:ival, 1))]</span>
</code></pre></div>

<p>Use first to return the node directly:</p>
<div class="codehilite"><pre><span></span><code><span class="n">ast</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="s1">&#39;(ival (ival _))&#39;</span><span class="p">)</span><span class="w">  </span><span class="c1">#=&gt; s(:ival, s(:ival, 1))</span>
</code></pre></div>

<p>Combine the <code>capture</code> method with <code>$</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">ast</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="s1">&#39;(ival (ival $_))&#39;</span><span class="p">)</span><span class="w"> </span><span class="c1"># =&gt; [1]</span>
</code></pre></div>

<h1 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">&para;</a></h1>
<p>Let's dive into a more complex example capturing fields and from clause of a
condition. Let's start parsing the sql:</p>
<h2 id="capturing-fields-and-where-clause">Capturing fields and where clause<a class="headerlink" href="#capturing-fields-and-where-clause" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="n">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Fast</span><span class="o">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="s1">&#39;select name from customer&#39;</span><span class="p">)</span>
<span class="c1">#   =&gt; s(:select_stmt,</span>
<span class="c1">#     s(:target_list,</span>
<span class="c1">#       s(:res_target,</span>
<span class="c1">#         s(:val,</span>
<span class="c1">#           s(:column_ref,</span>
<span class="c1">#             s(:fields,</span>
<span class="c1">#               s(:string,</span>
<span class="c1">#                 s(:str, &quot;name&quot;))))))),</span>
<span class="c1">#     s(:from_clause,</span>
<span class="c1">#       s(:range_var,</span>
<span class="c1">#         s(:relname, &quot;customer&quot;),</span>
<span class="c1">#         s(:inh, true),</span>
<span class="c1">#         s(:relpersistence, &quot;p&quot;))))</span>
</code></pre></div>

<p>Now, let's build the expression to get the fields and from_clause.</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="n">cols_and_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">   (select_stmt</span>
<span class="s2">     (target_list (res_target (val (column_ref (fields $...)))))</span>
<span class="s2">     (from_clause (range_var $(relname _))))</span>
<span class="s2">&quot;</span>
</code></pre></div>

<p>Now, we can use <code>Fast.capture</code> or <code>Fast.match?</code> to extract the values from the
AST.</p>
<div class="codehilite"><pre><span></span><code><span class="no">Fast</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="n">cols_and_from</span><span class="p">,</span><span class="w"> </span><span class="n">ast</span><span class="p">)</span>
<span class="c1"># =&gt; [s(:string,</span>
<span class="c1">#     s(:str, &quot;name&quot;)), s(:relname, &quot;customer&quot;)]</span>
</code></pre></div>

<h2 id="search-inside">Search inside<a class="headerlink" href="#search-inside" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="n">relname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Fast</span><span class="o">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="s1">&#39;select name from customer&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;relname&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; s(:relname, &quot;customer&quot;)</span>
</code></pre></div>

<p>Find the location of a node.</p>
<div class="codehilite"><pre><span></span><code><span class="n">relname</span><span class="o">.</span><span class="n">location</span><span class="w"> </span><span class="c1"># =&gt; #&lt;Parser::Source::Map:0x00007fd3bcb0b7f0</span>
<span class="c1">#  @expression=#&lt;Parser::Source::Range (sql) 17...25&gt;,</span>
<span class="c1">#  @node=s(:relname, &quot;customer&quot;)&gt;</span>
</code></pre></div>

<p>The location can be useful to allow you to do refactorings and find specific
delimitations of objects in the string.</p>
<p>The attribute <code>expression</code> gives access to the source range.</p>
<div class="codehilite"><pre><span></span><code><span class="n">relname</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">expression</span>
<span class="c1"># =&gt; #&lt;Parser::Source::Range (sql) 17...25&gt;</span>
</code></pre></div>

<p>The <code>source_buffer</code> is shared and can be accessed through the expression.</p>
<div class="codehilite"><pre><span></span><code><span class="n">relname</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">source_buffer</span>
<span class="c1"># =&gt; #&lt;Fast::SQL::SourceBuffer:0x00007fd3bc2a6420</span>
<span class="c1">#    @name=&quot;(sql)&quot;,</span>
<span class="c1">#    @source=&quot;select name from customer&quot;,</span>
<span class="c1">#    @tokens=</span>
<span class="c1">#     [&lt;PgQuery::ScanToken: start: 0, end: 6, token: :SELECT, keyword_kind: :RESERVED_KEYWORD&gt;,</span>
<span class="c1">#      &lt;PgQuery::ScanToken: start: 7, end: 11, token: :NAME_P, keyword_kind: :UNRESERVED_KEYWORD&gt;,</span>
<span class="c1">#      &lt;PgQuery::ScanToken: start: 12, end: 16, token: :FROM, keyword_kind: :RESERVED_KEYWORD&gt;,</span>
<span class="c1">#      &lt;PgQuery::ScanToken: start: 17, end: 25, token: :IDENT, keyword_kind: :NO_KEYWORD&gt;]&gt;</span>
</code></pre></div>

<p>The tokens are useful to find the proper node location during the build but
they're not available for all the nodes, so, it can be very handy as an extra
reference.</p>
<h2 id="replace">Replace<a class="headerlink" href="#replace" title="Permanent link">&para;</a></h2>
<p>Replace fragments of your SQL based on AST can also be done with all the work
inherited from Parser::TreeRewriter components.</p>
<div class="codehilite"><pre><span></span><code><span class="no">Fast</span><span class="o">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="s1">&#39;select 1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ival&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">)</span><span class="w"> </span><span class="c1"># =&gt; &quot;select 2&quot;</span>
</code></pre></div>

<p>The previous example is a syntax sugar for the following code:</p>
<div class="codehilite"><pre><span></span><code><span class="no">Fast</span><span class="o">.</span><span class="n">replace_sql</span><span class="p">(</span><span class="s1">&#39;ival&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="no">Fast</span><span class="o">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="s1">&#39;select 1&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="o">&amp;-&gt;</span><span class="p">(</span><span class="n">node</span><span class="p">){</span><span class="w"> </span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="c1"># =&gt; &quot;select 2&quot;</span>
</code></pre></div>

<p>The last argument is a proc that runs on the <a href="https://www.rubydoc.info/gems/parser/Parser/TreeRewriter">parser tree rewriter</a> scope.</p>
<p>Let's break down the previous code:</p>
<div class="codehilite"><pre><span></span><code><span class="n">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Fast</span><span class="o">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="s2">&quot;select 1&quot;</span><span class="p">)</span>
<span class="c1">#  =&gt; s(:select_stmt,</span>
<span class="c1">#    s(:target_list,</span>
<span class="c1">#      s(:res_target,</span>
<span class="c1">#        s(:val,</span>
<span class="c1">#          s(:a_const,</span>
<span class="c1">#            s(:ival,</span>
<span class="c1">#              s(:ival, 1)))))))</span>
</code></pre></div>

<p>The pattern is simply matching node type that is <code>ival</code> but it could be a complex expression
like <code>(val (a_const (val (ival (ival _)))))</code>.</p>
<p>Completing the example:</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="no">Fast</span><span class="o">.</span><span class="n">replace_sql</span><span class="p">(</span><span class="s2">&quot;ival&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ast</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">replace</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;3&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w"> </span><span class="c1"># =&gt; &quot;select 3&quot;</span>
</code></pre></div>

<p><code>loc</code> is a shortcut for <code>location</code> attribute.</p>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../videos/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Videos" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Videos
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>